<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HY-MT ç¿»è¯‘æœåŠ¡</title>
    <style>
        :root { --bg: #f5f5f5; --card: #fff; --text: #333; --border: #ddd; --primary: #4a90d9; --success: #52c41a; }
        .dark { --bg: #1a1a2e; --card: #16213e; --text: #eee; --border: #333; }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; background: var(--bg); color: var(--text); min-height: 100vh; padding: 20px; transition: all 0.3s; }
        .container { max-width: 1200px; margin: 0 auto; }
        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 10px; }
        h1 { font-size: 1.5rem; }
        .controls { display: flex; gap: 10px; }
        select, button, input, textarea { padding: 8px 12px; border: 1px solid var(--border); border-radius: 6px; background: var(--card); color: var(--text); font-size: 14px; }
        button { cursor: pointer; background: var(--primary); color: #fff; border: none; }
        button:hover { opacity: 0.9; }
        button:disabled { opacity: 0.5; cursor: not-allowed; }
        .main { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        @media (max-width: 768px) { .main { grid-template-columns: 1fr; } }
        .panel { background: var(--card); border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .panel h3 { margin-bottom: 15px; font-size: 1rem; display: flex; justify-content: space-between; align-items: center; }
        textarea { width: 100%; height: 200px; resize: vertical; font-size: 16px; line-height: 1.6; }
        .lang-row { display: flex; gap: 10px; margin-bottom: 15px; }
        .lang-row select { flex: 1; }
        .swap-btn { background: var(--card); color: var(--text); border: 1px solid var(--border); padding: 8px 15px; }
        .actions { display: flex; gap: 10px; margin-top: 15px; }
        .actions button { flex: 1; padding: 12px; font-size: 16px; }
        .btn-stream { background: #28a745; }
        .stats { font-size: 12px; color: #888; margin-top: 10px; padding: 10px; background: var(--bg); border-radius: 6px; }
        .stats span { margin-right: 15px; }
        .stats .highlight { color: var(--primary); font-weight: bold; }
        details { margin-top: 15px; }
        summary { cursor: pointer; color: var(--primary); font-size: 14px; }
        .params { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 12px; margin-top: 12px; }
        .param label { display: block; font-size: 12px; color: #888; margin-bottom: 4px; }
        .param input { width: 100%; }
        .param input[type="range"] { padding: 0; }
        .param .value { font-size: 11px; color: var(--primary); float: right; }
        .terms { margin-top: 12px; }
        .term-row { display: flex; gap: 8px; margin-bottom: 8px; }
        .term-row input { flex: 1; padding: 6px 10px; }
        .term-row button { padding: 6px 12px; font-size: 12px; }
        .gpu-bar { margin-top: 20px; padding: 15px; background: var(--card); border-radius: 8px; }
        .gpu-bar h4 { font-size: 14px; margin-bottom: 10px; }
        .gpu-info { display: flex; gap: 20px; flex-wrap: wrap; font-size: 13px; }
        .gpu-info span { display: flex; align-items: center; gap: 5px; }
        .dot { width: 8px; height: 8px; border-radius: 50%; }
        .dot.on { background: var(--success); }
        .dot.off { background: #999; }
        #loading { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 100; justify-content: center; align-items: center; }
        .spinner { border: 3px solid #333; border-top-color: var(--primary); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .copy-btn { background: transparent; color: var(--text); border: 1px solid var(--border); padding: 4px 10px; font-size: 12px; }
        .progress-bar { height: 4px; background: var(--border); border-radius: 2px; margin: 10px 0; overflow: hidden; display: none; }
        .progress-fill { height: 100%; background: var(--primary); transition: width 0.3s; width: 0%; }
        .file-upload { border: 2px dashed var(--border); border-radius: 8px; padding: 15px; text-align: center; cursor: pointer; margin-bottom: 10px; font-size: 13px; }
        .file-upload:hover { border-color: var(--primary); }
        .file-upload.dragover { border-color: var(--primary); background: rgba(74,144,217,0.1); }
        .file-upload input { display: none; }
        .chunk-item { padding: 8px; margin: 4px 0; background: var(--bg); border-left: 3px solid var(--primary); border-radius: 0 4px 4px 0; font-size: 14px; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ğŸŒ HY-MT ç¿»è¯‘æœåŠ¡</h1>
            <div class="controls">
                <button onclick="toggleTheme()" title="åˆ‡æ¢ä¸»é¢˜">ğŸŒ“</button>
                <a href="/docs" target="_blank"><button type="button">ğŸ“š APIæ–‡æ¡£</button></a>
            </div>
        </header>

        <div class="main">
            <div class="panel">
                <h3>æºæ–‡æœ¬ <button class="copy-btn" onclick="copyText('source')">å¤åˆ¶</button></h3>
                
                <div class="file-upload" id="dropZone">
                    ğŸ“ æ‹–æ‹½æ–‡æœ¬æ–‡ä»¶æˆ–ç‚¹å‡»ä¸Šä¼ 
                    <input type="file" id="fileInput" accept=".txt,.md,.text">
                </div>
                
                <div class="lang-row">
                    <select id="source-lang"></select>
                    <button class="swap-btn" onclick="swapLang()">â‡„</button>
                    <select id="target-lang"></select>
                </div>
                <textarea id="source" placeholder="è¾“å…¥è¦ç¿»è¯‘çš„æ–‡æœ¬..."></textarea>
                
                <details>
                    <summary>âš™ï¸ é«˜çº§å‚æ•°</summary>
                    <div class="params">
                        <div class="param">
                            <label>Temperature <span class="value" id="temp-val">0.7</span></label>
                            <input type="range" id="temperature" min="0" max="2" step="0.1" value="0.7" oninput="updateVal('temp-val', this.value)">
                        </div>
                        <div class="param">
                            <label>Top-P <span class="value" id="topp-val">0.6</span></label>
                            <input type="range" id="top_p" min="0" max="1" step="0.1" value="0.6" oninput="updateVal('topp-val', this.value)">
                        </div>
                        <div class="param">
                            <label>Top-K <span class="value" id="topk-val">20</span></label>
                            <input type="range" id="top_k" min="1" max="100" step="1" value="20" oninput="updateVal('topk-val', this.value)">
                        </div>
                        <div class="param">
                            <label>é‡å¤æƒ©ç½š <span class="value" id="rep-val">1.1</span></label>
                            <input type="range" id="repetition_penalty" min="1" max="2" step="0.05" value="1.1" oninput="updateVal('rep-val', this.value)">
                        </div>
                    </div>
                    <div class="terms">
                        <label style="font-size:13px;">æœ¯è¯­å¹²é¢„ (å¯é€‰)</label>
                        <div id="terms-list"></div>
                        <button onclick="addTerm()" style="margin-top:8px;padding:6px 12px;font-size:12px;">+ æ·»åŠ æœ¯è¯­</button>
                    </div>
                    <div style="margin-top:12px;">
                        <label style="font-size:13px;">ä¸Šä¸‹æ–‡å‚è€ƒ (å¯é€‰)</label>
                        <textarea id="context" style="height:60px;margin-top:6px;" placeholder="æä¾›ä¸Šä¸‹æ–‡å¸®åŠ©æé«˜ç¿»è¯‘è´¨é‡..."></textarea>
                    </div>
                </details>
                
                <div class="actions">
                    <button onclick="doTranslate(false)" id="translate-btn">ğŸš€ ç¿»è¯‘</button>
                    <button onclick="doTranslate(true)" id="stream-btn" class="btn-stream">âš¡ æµå¼</button>
                    <button onclick="clearAll()" style="background:#666;flex:0.5;">æ¸…ç©º</button>
                </div>
            </div>

            <div class="panel">
                <h3>ç¿»è¯‘ç»“æœ <button class="copy-btn" onclick="copyText('result')">å¤åˆ¶</button></h3>
                <div class="progress-bar" id="progressBar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                <textarea id="result" readonly placeholder="ç¿»è¯‘ç»“æœå°†æ˜¾ç¤ºåœ¨è¿™é‡Œ..."></textarea>
                <div id="streamOutput" style="display:none;max-height:200px;overflow-y:auto;"></div>
                <div class="stats" id="stats" style="display:none;">
                    <span>â±ï¸ è€—æ—¶: <span class="highlight" id="stat-time">-</span></span>
                    <span>ğŸ“ è¾“å…¥: <span id="stat-input">-</span> å­—ç¬¦</span>
                    <span>ğŸ“„ è¾“å‡º: <span id="stat-output">-</span> å­—ç¬¦</span>
                    <span>ğŸ“¦ åˆ†æ®µ: <span id="stat-chunks">-</span></span>
                </div>
            </div>
        </div>

        <div class="gpu-bar">
            <h4>ğŸ–¥ï¸ GPU çŠ¶æ€</h4>
            <div class="gpu-info">
                <span><span class="dot" id="gpu-dot"></span> <span id="gpu-status">æ£€æŸ¥ä¸­...</span></span>
                <span>ğŸ’¾ æ˜¾å­˜: <span id="gpu-mem">-</span></span>
                <span>â° ç©ºé—²: <span id="gpu-idle">-</span></span>
                <span>ğŸ¤– æ¨¡å‹: <span id="gpu-model">-</span></span>
                <button onclick="releaseGPU()" style="padding:4px 10px;font-size:12px;">é‡Šæ”¾æ˜¾å­˜</button>
            </div>
        </div>
    </div>

    <div id="loading"><div class="spinner"></div></div>

    <script>
        const LANGS = {};
        
        async function init() {
            const langs = await fetch('/api/languages').then(r => r.json());
            Object.assign(LANGS, langs);
            
            const srcSel = document.getElementById('source-lang');
            const tgtSel = document.getElementById('target-lang');
            srcSel.innerHTML = '<option value="">è‡ªåŠ¨æ£€æµ‹</option>';
            tgtSel.innerHTML = '';
            
            for (const [code, name] of Object.entries(langs)) {
                srcSel.innerHTML += `<option value="${code}">${name} (${code})</option>`;
                tgtSel.innerHTML += `<option value="${code}">${name} (${code})</option>`;
            }
            tgtSel.value = 'zh';
            
            updateGPU();
            setInterval(updateGPU, 10000);
            
            if (localStorage.getItem('theme') === 'dark') document.body.classList.add('dark');
            
            // æ–‡ä»¶ä¸Šä¼ 
            const dropZone = document.getElementById('dropZone');
            const fileInput = document.getElementById('fileInput');
            dropZone.onclick = () => fileInput.click();
            dropZone.ondragover = (e) => { e.preventDefault(); dropZone.classList.add('dragover'); };
            dropZone.ondragleave = () => dropZone.classList.remove('dragover');
            dropZone.ondrop = (e) => { e.preventDefault(); dropZone.classList.remove('dragover'); handleFile(e.dataTransfer.files[0]); };
            fileInput.onchange = () => handleFile(fileInput.files[0]);
        }
        
        function handleFile(file) {
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                document.getElementById('source').value = e.target.result;
                document.getElementById('dropZone').innerHTML = `ğŸ“„ ${file.name} (${(file.size/1024).toFixed(1)}KB)<input type="file" id="fileInput" accept=".txt,.md,.text">`;
            };
            reader.readAsText(file);
        }
        
        async function updateGPU() {
            try {
                const data = await fetch('/api/gpu/status').then(r => r.json());
                document.getElementById('gpu-dot').className = 'dot ' + (data.loaded ? 'on' : 'off');
                document.getElementById('gpu-status').textContent = data.loaded ? 'å·²åŠ è½½' : 'æœªåŠ è½½';
                document.getElementById('gpu-mem').textContent = `${data.gpu_free_mb} / ${data.gpu_total_mb} MB`;
                document.getElementById('gpu-idle').textContent = data.idle_seconds !== null ? `${data.idle_seconds}ç§’` : '-';
                document.getElementById('gpu-model').textContent = data.model_name || '-';
            } catch(e) {}
        }
        
        async function doTranslate(stream = false) {
            const text = document.getElementById('source').value.trim();
            if (!text) return alert('è¯·è¾“å…¥è¦ç¿»è¯‘çš„æ–‡æœ¬');
            
            const btn = document.getElementById(stream ? 'stream-btn' : 'translate-btn');
            const otherBtn = document.getElementById(stream ? 'translate-btn' : 'stream-btn');
            btn.disabled = otherBtn.disabled = true;
            btn.textContent = 'ç¿»è¯‘ä¸­...';
            
            const progressBar = document.getElementById('progressBar');
            const progressFill = document.getElementById('progressFill');
            const streamOutput = document.getElementById('streamOutput');
            const resultArea = document.getElementById('result');
            
            progressBar.style.display = stream ? 'block' : 'none';
            progressFill.style.width = '0%';
            streamOutput.style.display = stream ? 'block' : 'none';
            streamOutput.innerHTML = '';
            resultArea.style.display = stream ? 'none' : 'block';
            
            if (!stream) document.getElementById('loading').style.display = 'flex';
            
            const terms = {};
            document.querySelectorAll('.term-row').forEach(row => {
                const inputs = row.querySelectorAll('input');
                if (inputs[0].value && inputs[1].value) terms[inputs[0].value] = inputs[1].value;
            });
            
            const body = {
                text,
                target_lang: document.getElementById('target-lang').value,
                source_lang: document.getElementById('source-lang').value || null,
                temperature: parseFloat(document.getElementById('temperature').value),
                top_p: parseFloat(document.getElementById('top_p').value),
                top_k: parseInt(document.getElementById('top_k').value),
                repetition_penalty: parseFloat(document.getElementById('repetition_penalty').value),
                context: document.getElementById('context').value || null,
                terms: Object.keys(terms).length > 0 ? terms : null,
                stream
            };
            
            try {
                if (stream) {
                    // æµå¼ç¿»è¯‘
                    const response = await fetch('/api/translate', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify(body)
                    });
                    
                    const reader = response.body.getReader();
                    const decoder = new TextDecoder();
                    let results = [];
                    let totalChunks = 1;
                    
                    while (true) {
                        const { done, value } = await reader.read();
                        if (done) break;
                        
                        const lines = decoder.decode(value).split('\n');
                        for (const line of lines) {
                            if (line.startsWith('data: ')) {
                                try {
                                    const data = JSON.parse(line.slice(6));
                                    if (data.event === 'start') {
                                        totalChunks = data.total_chunks;
                                        document.getElementById('stat-input').textContent = data.input_length;
                                        document.getElementById('stat-chunks').textContent = totalChunks;
                                    } else if (data.event === 'chunk') {
                                        results.push(data.result);
                                        progressFill.style.width = (data.chunk / data.total * 100) + '%';
                                        const div = document.createElement('div');
                                        div.className = 'chunk-item';
                                        div.innerHTML = `<small style="color:#888">ç¬¬${data.chunk}æ®µ (${data.elapsed_ms}ms)</small><br>${data.result}`;
                                        streamOutput.appendChild(div);
                                        streamOutput.scrollTop = streamOutput.scrollHeight;
                                    } else if (data.event === 'done') {
                                        // å®Œæˆåéšè—åˆ†æ®µï¼Œæ˜¾ç¤ºåˆå¹¶ç»“æœ
                                        streamOutput.style.display = 'none';
                                        resultArea.style.display = 'block';
                                        document.getElementById('stat-time').textContent = data.elapsed_ms + ' ms';
                                        document.getElementById('stat-output').textContent = data.output_length;
                                        document.getElementById('stats').style.display = 'block';
                                        resultArea.value = results.join('\n');
                                    }
                                } catch(e) {}
                            }
                        }
                    }
                } else {
                    // æ™®é€šç¿»è¯‘
                    const res = await fetch('/api/translate', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify(body)
                    });
                    const data = await res.json();
                    
                    if (data.status === 'success') {
                        resultArea.value = data.result;
                        document.getElementById('stats').style.display = 'block';
                        document.getElementById('stat-time').textContent = data.elapsed_ms + ' ms';
                        document.getElementById('stat-input').textContent = data.input_length;
                        document.getElementById('stat-output').textContent = data.output_length;
                        document.getElementById('stat-chunks').textContent = data.chunks;
                    } else {
                        alert('ç¿»è¯‘å¤±è´¥: ' + (data.detail || data.error));
                    }
                }
            } catch(e) {
                alert('è¯·æ±‚å¤±è´¥: ' + e.message);
            } finally {
                btn.disabled = otherBtn.disabled = false;
                btn.textContent = stream ? 'âš¡ æµå¼' : 'ğŸš€ ç¿»è¯‘';
                document.getElementById('loading').style.display = 'none';
                updateGPU();
            }
        }
        
        function swapLang() {
            const src = document.getElementById('source-lang');
            const tgt = document.getElementById('target-lang');
            if (src.value) [src.value, tgt.value] = [tgt.value, src.value];
            const srcText = document.getElementById('source').value;
            const tgtText = document.getElementById('result').value;
            if (tgtText) {
                document.getElementById('source').value = tgtText;
                document.getElementById('result').value = srcText;
            }
        }
        
        function clearAll() {
            document.getElementById('source').value = '';
            document.getElementById('result').value = '';
            document.getElementById('context').value = '';
            document.getElementById('stats').style.display = 'none';
            document.getElementById('terms-list').innerHTML = '';
            document.getElementById('streamOutput').innerHTML = '';
            document.getElementById('streamOutput').style.display = 'none';
            document.getElementById('result').style.display = 'block';
            document.getElementById('progressBar').style.display = 'none';
        }
        
        function copyText(id) {
            const text = document.getElementById(id).value;
            navigator.clipboard.writeText(text).then(() => alert('å·²å¤åˆ¶'));
        }
        
        function toggleTheme() {
            document.body.classList.toggle('dark');
            localStorage.setItem('theme', document.body.classList.contains('dark') ? 'dark' : 'light');
        }
        
        function updateVal(id, val) { document.getElementById(id).textContent = val; }
        
        function addTerm() {
            const list = document.getElementById('terms-list');
            const row = document.createElement('div');
            row.className = 'term-row';
            row.innerHTML = `<input placeholder="åŸæ–‡æœ¯è¯­"><input placeholder="ç¿»è¯‘"><button onclick="this.parentElement.remove()">âœ•</button>`;
            list.appendChild(row);
        }
        
        async function releaseGPU() {
            await fetch('/api/gpu/offload', {method: 'POST'});
            updateGPU();
        }
        
        document.addEventListener('keydown', e => { if (e.ctrlKey && e.key === 'Enter') doTranslate(false); });
        
        init();
    </script>
</body>
</html>
